<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Real Time Chat â€” {{ username }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="chat-body">

    <div id="chat-box">
        <h2>Selamat Datang, {{ username }}!</h2>
        <ul id="messages"></ul>
        <form id="message-form" action="#" method="POST">
            <input type="text" id="message_input" placeholder="Ketik pesanmu..." autocomplete="off" />
            <button id="send_button" type="submit">Kirim</button>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const currentUser = "{{ username }}";

        $(document).ready(function () {
            const socket = io();

            socket.on('connect', () => {
                socket.emit('join', {});
            });

            $('#message-form').submit(function (e) {
                e.preventDefault();
                const msg = $('#message_input').val().trim();
                if (msg !== '') {
                    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    socket.emit('message', { data: msg, time: timestamp });
                    $('#message_input').val('');
                }
            });

            socket.on('response', function (data) {
                const { username, message, time } = data;
                const isOwnMessage = username === currentUser;

                const html = `
                <li class="chat-item ${isOwnMessage ? 'own' : 'other'}">
                    <div class="chat-avatar">
                        <img src="https://ui-avatars.com/api/?name=${username}&background=${isOwnMessage ? '34c759' : '007bff'}&color=fff&rounded=true" alt="avatar">
                    </div>
                    <div class="chat-bubble">
                        <div class="chat-username">${username}</div>
                        <div class="chat-message">${message}</div>
                        <div class="chat-time">${time}</div>
                    </div>
                </li>
            `;
                $('#messages').append(html);
                scrollToBottom();
            });

            socket.on('status', function (msg) {
                $('#messages').append(`<li class="status">${msg.msg}</li>`);
                scrollToBottom();
            });

            function scrollToBottom() {
                const messages = document.getElementById("messages");
                messages.scrollTop = messages.scrollHeight;
            }
        });
    </script>
</body>

</html>